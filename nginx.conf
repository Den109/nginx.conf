user  www-data;
worker_processes auto;
worker_cpu_affinity auto;

pcre_jit on;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

load_module /etc/nginx/modules/ngx_http_waf_module.so;
#закомментить чтоб попасть в phpmyadmin


          events {
                  worker_connections  1024;
                  multi_accept on;
          }


          http  {

                charset utf-8;
                charset_types utf-8;
                include           /etc/nginx/mime.types;
                default_type      application/octet-stream;
                server_tokens     off;
                log_format  main_ext                        '$remote_addr - $remote_user [$time_local] "$request" '
                                                            '$status $body_bytes_sent "$http_referer" '
                                                            '"$http_user_agent" "$http_x_forwarded_for" '
                                                            '"$host" sn="$server_name" '
                                                            'rt=$request_time '
                                                            'ua="$upstream_addr" us="$upstream_status" '
                                                            'ut="$upstream_response_time" ul="$upstream_response_length" '
                                                            'cs=$upstream_cache_status' ;

                access_log  /var/log/nginx/access.log  main_ext;
                error_log  /var/log/nginx/error.log warn;


                 #Nemesida WAF
                #Request body too large fix
                client_body_buffer_size 25M;

               include /etc/nginx/nwaf/conf/global/*.conf;
               #закомментить чтоб попасть в phpmyadmin
               include /etc/nginx/nwaf/conf/vhosts/*.conf;
               #закомментить чтоб попасть в phpmyadmin


                sendfile       on;
                tcp_nopush     on;
                tcp_nodelay    on;
                reset_timedout_connection on;
                keepalive_timeout  120;
                keepalive_requests 1000;


                map $http_accept $webp_suffix {
                   "~*webp"  ".webp";
                }
                map $msie $cache_control {
                    "1"     "private";
                }
                map $msie $vary_header {
                    default "Accept";
                    "1"     "";
                }



                 map $http_user_agent $mobile_request {
                  default                  fullversion;

                  "~*ipad"    mobileversion;
                  "~*android.*mobile"   mobileversion;
                  "~*iphone"    mobileversion;
                  "~*ipod.*mobile"   mobileversion;
                  "~*BlackBerry*Mobile Safari"  mobileversion;
                  "~*BB*Mobile Safari"   mobileversion;
                  "~*Opera.*Mini/7"   mobileversion;
                  "~*IEMobile/10.*Touch"   mobileversion;
                  "~*IEMobile/11.*Touch"   mobileversion;
                  "~*IEMobile/7.0"   mobileversion;
                  "~*IEMobile/9.0"   mobileversion;
                  "~*Firefox.*Mobile"   mobileversion;
                  "~*webOS"    mobileversion;
                 }


               #fastcgi_cache_path /var/cache/nginx/potreb levels=1:2 keys_zone=potreb:10m inactive=1y max_size=100m;



                server {
                        listen 80;
                        server_name  potreballiance.ru www.potreballiance.ru;
                        return 301 https://potreballiance.ru$request_uri;
                        root /usr/share/nginx/html;

                }

                server {
                        listen 443;
                        server_name www.potreballiance.ru;
                        root /usr/share/nginx/html;
                        return 301 https://potreballiance.ru$request_uri;
                }

                server {
                        listen 443 default_server ssl http2 fastopen=256;
                        server_name potreballiance.ru;
                        root /usr/share/nginx/html;



                        #if ($host ~* www.) {
                        #                       return 301 https://potreballiance.ru$request_uri;
                        #                   }

                        ssl_buffer_size 8k;
                        ssl_certificate /etc/letsencrypt/live/potreballiance.ru/fullchain.pem;
                        ssl_certificate_key /etc/letsencrypt/live/potreballiance.ru/privkey.pem;
                        #ssl_certificate /etc/letsencrypt/live/www.potreballiance.ru/fullchain.pem;
                        #ssl_certificate_key /etc/letsencrypt/live/www.potreballiance.ru/privkey.pem;
                        ssl_session_timeout 2d;
                        #ssl_session_cache shared:le_nginx_SSL:20m;#share распределяется между воркерами, 20мб для записи сессий
                       #ssl_session_tickets on; #хранит данные ssl сессий на клиетне типа так быстрее чем на сервере не все браузеры поддерживают
                       #ssl_session_ticket_key file.key; ключ для tickets on
                       #ssl_handshake_timeout 10s; #время завершения установки соединения ssl это вроде только в mod_stream есть
                        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # протоколы, которые надо использовать
                        ssl_ciphers "ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS";
                        ssl_prefer_server_ciphers on; # предпочтение серверных шифров ssl_ciphers
                        ssl_stapling on; #  Прикрепление OCSP-ответов сервером для проверки актуальности вертификата
                        ssl_stapling_verify on; #проверка сервером ответов OCSP
                        ssl_trusted_certificate /etc/letsencrypt/live/potreballiance.ru/chain.pem; # файл с доверенным сертификатом
                        resolver 8.8.8.8 8.8.4.4 valid=300s ipv6=off;
                        resolver_timeout 5s;


                        autoindex off;
                        etag off;
                        #include /etc/letsencrypt/options-ssl-nginx.conf;  managed by Certbot

                        add_header X-XSS-Protection "1; mode=block";
                        add_header Strict-Transport-Security max-age=15768000; #сайт доступен только по https
                        #add_header X-Frame-Options "DENY";
                        add_header X-Content-Type-Options nosniff;

                        brotli_static on;
                        brotli on;
                        brotli_comp_level 7;
                        brotli_types text/plain text/css text/xml application/x-javascript application/javascript text/javascript;


                        gzip on;
                        gzip_static on;
                        gzip_vary on;
                        gzip_min_length 1100;
                        gzip_buffers 64 8k;
                        gzip_comp_level 7;
                        gzip_http_version 1.1;
                        gzip_proxied any;
                        gzip_types text/plain text/css text/xml image/svg+xml image/x-icon application/xml application/x-javascript application/javascript text/javascript application/xml+rss application/json;
                        gzip_disable "MSIE [1-6]\.(?!.*SV1)";

                        #fastcgi_cache potreb;
                        #fastcgi_cache_key "$scheme$request_method$host$request_uri";
                        fastcgi_cache_key "$scheme$request_method$host$request_uri$mobile_request";
                        fastcgi_cache_use_stale error timeout invalid_header updating http_500 http_503;
                        fastcgi_cache_valid 200 301 302 404 6d;
                        fastcgi_buffers 16 16k;

                        fastcgi_buffer_size 32k;
                        fastcgi_param SERVER_NAME $http_host;
                        fastcgi_ignore_headers Cache-Control Expires Set-Cookie;
                        fastcgi_keep_conn on;
                       #fastcgi_cache_min_uses 1;

                       #add_header X-Proxy-Cache $upstream_cache_status;
                       #fastcgi_cache_bypass $http_pragma;

                location = /proektnaya-dokumentaciya-dlya-avtomojki {
                           return 301 /ekspertiza-proektnoj-dokumentacii-dlya-avtomojki;
                }
                location = /proektnaya-dokumentaciya-dlya-avtomojki.amp {
                           return 301 /ekspertiza-proektnoj-dokumentacii-dlya-avtomojki.amp;
                }

                location = /76-priznakov-dlya-proverki-zastrojshika {
                           return 301 /nadezhnye-zastroyshchiki;
                }

                location = /76-priznakov-dlya-proverki-zastrojshika.amp {
                           return 301 /nadezhnye-zastroyshchiki.amp;
                }

                location = /nedvizhimost {
                           return 301 /zashchita-prav-dolshchikov;
                }

                location = /nedvizhimost.amp {
                           return 301 /zashchita-prav-dolshchikov.amp;
                           #на категории .amp отстутствует
                }

                location = /yurist-po-nedvizhimosti {
                           return 301 /yurist-po-nedvizhimosti-v-moskve;
                }
                location = /yurist-po-nedvizhimosti.amp {
                           return 301 /yurist-po-nedvizhimosti-v-moskve.amp;
                }

                location = /bank-podal-v-sud-za-neuplatu {
                           return 301 /bank-podal-v-sud-za-neuplatu-kredita;
                }
                location = /bank-podal-v-sud-za-neuplatu.amp {
                           return 301 /bank-podal-v-sud-za-neuplatu-kredita.amp;
                }

                location = /podmennyj-avtomobil {
                           return 301 /podmennyj-avtomobil-na-vremya-remonta-po-garantii;
                }
                location = /podmennyj-avtomobil.amp {
                         return 301 /podmennyj-avtomobil-na-vremya-remonta-po-garantii.amp;
                }

                location = /otkaz-ot-strahovki-po-kreditu {
                           return 301 /kak-otkazatsya-ot-strahovki-po-kreditu;
                }
                location = /otkaz-ot-strahovki-po-kreditu.amp {
                           return 301 /kak-otkazatsya-ot-strahovki-po-kreditu.amp;
                }
                location = /kak-proverit-nadejnost-i-vibrat-zastroyshika {
                            return 301 /nadezhnye-zastroyshchiki;
                }
                location = /kak-proverit-nadejnost-i-vibrat-zastroyshika.amp {
                           return 301 /nadezhnye-zastroyshchiki.amp;
                }

                location = /neustoika-po-zpp {
                           return 301 /neustoyka-po-zakonu-o-zashchite-prav-potrebiteley;
                }
                location = /neustoika-po-zpp.amp {
                           return 301 /neustoyka-po-zakonu-o-zashchite-prav-potrebiteley.amp;
                }

                location = /navyazali-strahovku-po-kreditu {
                           return 301 /kak-vernut-strahovku-navyazannuyu-bankom-pri-oformlenii-kredita;
                }
                location = /navyazali-strahovku-po-kreditu.amp {
                           return 301 /kak-vernut-strahovku-navyazannuyu-bankom-pri-oformlenii-kredita.amp;
                }


                        location / {
                                root   /usr/share/nginx/html;
                                index index.php index.html index.htm;
                                try_files $uri $uri/ /index.php?$args;

                                if (!-e $request_filename){
                                                          rewrite ^/(.*)index.php$ /$1 redirect;
                                                          }

                                    rewrite ^/(.*)\.html$ /$1 redirect;
                                    rewrite ^/(.*)/$ /$1 redirect;
                                    rewrite ^/([a-zA-Z0-9-_]+)$ /index.php?name=$1 last;
                                    rewrite ^/([a-zA-Z0-9-_]+)/page:([0-9]+)$ /index.php?name=$1&page=$2;
                                    rewrite ^/([a-zA-Z0-9-_]+)/([a-zA-Z0-9-_]+)$ /index.php?name=$1&option=$2;
                                    rewrite ^/([a-zA-Z0-9-_]+)/([a-zA-Z0-9-_]+)/([a-zA-Z0-9-_]+)$ /index.php?name=$1&option=$2&action=$3;
                                    rewrite ^/([a-zA-Z0-9-_]+)/([a-zA-Z0-9-_]+)/page:([0-9]+)$ /index.php?name=$1&option=$2&page=$3;
                                    rewrite ^/([a-zA-Z0-9-_]+).amp$ /index.php?&amp=1&name=$1 last;
                                    rewrite ^/([a-zA-Z0-9-_]+).pdf$ /pdf-article.php?name=$1 last;
                                    rewrite ^/([a-zA-Z0-9-_]+).htm$ /print-article.php?name=$1 last;
                                    rewrite /sitemap.xml /sitemap.php last;
                        }



                        location /404.html {
                                error_page  404 /404.html;
                                root /usr/share/nginx/html;
                        }

                        location = /50x.html {
                                error_page   500 502 503 504  /50x.html;
                                root  /usr/share/nginx/html;
                        }


                        location ~ .(html|jpg|png|gif|jpeg|css|js|ico|webp|svg)$ {
                                expires 6M;
                                add_header Cache-Control public;
                                add_header Cache-Control immutable;
                                try_files $uri$webp_suffix $uri =404;
                        }

                        location ~ \.php$ {
                                root  /usr/share/nginx/html;
                                try_files $uri =404;

                                fastcgi_pass   unix:/run/php/php7.0-fpm.sock;
                                fastcgi_index  index.php;
                                fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
                                include fastcgi_params;
                        }

                        location ~ \.php$ {
                                                  try_files $uri =404;
                                                  include fastcgi_params;
                                                  fastcgi_pass unix:/run/php/php7.0-fpm.sock;
                                                  fastcgi_cache_bypass $skip_cache;
                                                  fastcgi_no_cache $skip_cache;
                                                  #fastcgi_cache potreb;
                                                }

                        set $skip_cache 0;
                        set $var_desktop "fullversion";
                        set $var_mobile "mobileversion";
                        # POST requests and URL with a query string should always go to php
                        if ($request_method = POST) {
                          set $skip_cache 1;
                        }
                        if ($query_string != "") {
                          set $skip_cache 1;
                        }
                        # Don't cache URL containing the following segments
                        #if ($request_uri ~* "(/wp-admin/|/xmlrpc.php|wp-.*.php|index.php|/feed/|sitemap(_index)?.xml|[a-z0-9_-]+-sitemap([0-9]+)?.xml)") {
                        #  set $skip_cache 1;
                        #}
                        # Don't use the cache for logged in users or recent commenter
                        #if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
                        #  set $skip_cache 1;
                        #}
                        # Use cached or actual file if they exists, Otherwise pass request to WordPress
                       # location / {
                       #   try_files $uri $uri/ /index.php?$args;
                       # }
                        #location ~ ^/wp-content/cache/minify/(.+\.(css|js))$ {
                        #  try_files $uri /wp-content/plugins/w3-total-cache/pub/minify.php?file=$1;
                        #}
                        location ~ \.php$ {
                                 try_files $uri =404;
                                 include fastcgi_params;
                                 #fastcgi_pass php;
                                 fastcgi_cache_bypass $skip_cache;
                                 fastcgi_no_cache $skip_cache;
                                 #fastcgi_cache WORDPRESS;
                        }

                        #location ~ /purge(/.*) {
                        #  fastcgi_cache_purge WORDPRESS "$scheme$request_method$host$1$var_desktop";
                        #  access_log off;
                        #}
                        #location ~ /mpurge(/.*) {
                        #  fastcgi_cache_purge WORDPRESS "$scheme$request_method$host$1$var_mobile";
                        #  access_log off;
                        #}

                        #location /phpmyadmin {
                        #                     root /usr/share/;
                        #                      index index.php index.html index.htm;
                        #                      location ~ ^/phpmyadmin/(.+\.php)$ {
                        #                               try_files $uri =404;
                        #                               root /usr/share/;
                        #                               fastcgi_pass unix:/run/php/php7.0-fpm.sock;
                        #                               fastcgi_index index.php;
                        #                               fastcgi_param SCRIPT_FILENAME $request_filename;
                        #                               include /etc/nginx/fastcgi_params;
                        #                      }

                        #                    location ~* ^/phpmyadmin/(.+\.(jpg|jpeg|gif|css|png|js|ico|html|xml|txt))$ {
                        #                            root /usr/share/;
                        #                   }
                        #}

                        #location /phpMyAdmin {
                        #                     rewrite ^/* /phpmyadmin last;
                        #}
                }
            include /etc/nginx/conf.d/*.conf;
          }



